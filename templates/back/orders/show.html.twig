{% extends 'back/base.html.twig' %}

{% block title %}Détails de la commande{% endblock %}

{% block content %}
<div class="page-inner pt-3">
    <div class="page-header d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="page-title fw-bold">Commande #{{ order.id }}</h2>
            <div class="d-flex align-items-center text-muted">
                <a href="{{ path('admin_dashboard') }}" class="text-decoration-none text-primary">
                    <i class="fa fa-home mr-1"></i> Tableau de bord
                </a>
                <i class="fa fa-chevron-right mx-2 small"></i>
                <a href="{{ path('admin_orders_index') }}" class="text-decoration-none text-primary">
                    <i class="fa fa-shopping-cart mr-1"></i> Commandes
                </a>
                <i class="fa fa-chevron-right mx-2 small"></i>
                <span>Détails</span>
            </div>
        </div>
        <div>
            <a href="{{ path('admin_orders_pdf', {'id': order.id}) }}" class="btn btn-danger btn-sm shadow-sm rounded-3 mr-2" target="_blank">
                <i class="fa fa-file-pdf mr-2"></i> Exporter PDF
            </a>
            <a href="{{ path('admin_orders_index') }}" class="btn btn-primary btn-sm shadow-sm rounded-3">
                <i class="fa fa-arrow-left mr-2"></i> Retour
            </a>
        </div>
    </div>
    
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }} alert-dismissible fade show rounded-3 shadow-sm" role="alert">
                <i class="fa {% if label == 'success' %}fa-check-circle{% elseif label == 'danger' %}fa-exclamation-circle{% elseif label == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} mr-2"></i>
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
        {% endfor %}
    {% endfor %}
    
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0 fw-bold">Statut de la Commande</h5>
                </div>
                <div class="card-body p-4">
                    <!-- Order Status Badge -->
                    <div class="d-flex align-items-center mb-4">
                        <h6 class="mb-0 mr-3">Statut actuel:</h6>
                        {% if order.status == 'pending' %}
                            <span class="badge bg-warning text-dark px-3 py-2">En attente</span>
                        {% elseif order.status == 'done' %}
                            <span class="badge bg-success px-3 py-2">Terminée</span>
                        {% elseif order.status == 'canceled' %}
                            <span class="badge bg-danger px-3 py-2">Annulée</span>
                        {% endif %}
                    </div>
                    
                    <!-- Status Change Options -->
                    <div class="d-flex flex-wrap gap-2">
                        <form method="GET" action="{{ path('admin_orders_update_status', {'id': order.id, 'status': 'pending'}) }}" onsubmit="return confirmStatusChange('pending');">
                            <button type="submit" class="btn btn-outline-warning rounded-3 px-3">
                                <i class="fa fa-clock mr-2"></i> En attente
                            </button>
                        </form>
                        <form method="GET" action="{{ path('admin_orders_update_status', {'id': order.id, 'status': 'done'}) }}" onsubmit="return confirmStatusChange('done');">
                            <button type="submit" class="btn btn-outline-success rounded-3 px-3">
                                <i class="fa fa-check-circle mr-2"></i> Terminée
                            </button>
                        </form>
                        <form method="GET" action="{{ path('admin_orders_update_status', {'id': order.id, 'status': 'canceled'}) }}" onsubmit="return confirmStatusChange('canceled');">
                            <button type="submit" class="btn btn-outline-danger rounded-3 px-3">
                                <i class="fa fa-times-circle mr-2"></i> Annulée
                            </button>
                        </form>
                        <button type="button" onclick="updateProductStock()" class="btn btn-outline-info rounded-3 px-3">
                            <i class="fa fa-sync mr-2"></i> Mettre à jour le stock
                        </button>
                        <form method="POST" action="{{ path('admin_orders_delete', {'id': order.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette commande?');">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ order.id) }}">
                            <button type="submit" class="btn btn-outline-danger rounded-3 px-3">
                                <i class="fa fa-trash mr-2"></i> Supprimer
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
                
    <!-- Customer & Order Information -->    
    <div class="row mb-4">
        <!-- Customer Information Card -->
        <div class="col-lg-6 mb-4 mb-lg-0">
            <div class="card border-0 shadow-sm rounded-3 h-100">
                <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i class="fa fa-user-circle mr-2 text-primary"></i>Informations Client</h5>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex flex-column">
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="icon-big text-center icon-primary mr-3">
                                    <i class="fa fa-user text-primary"></i>
                                </span>
                                <h6 class="mb-0 fw-bold">{{ order.customerName }}</h6>
                            </div>
                            <p class="mb-1 ms-5 text-muted">
                                <i class="fa fa-envelope mr-2 small"></i>{{ order.customerEmail }}
                            </p>
                            {% if order.phone %}
                            <p class="mb-0 ms-5 text-muted">
                                <i class="fa fa-phone mr-2 small"></i>{{ order.phone }}
                            </p>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="icon-big text-center icon-primary mr-3">
                                    <i class="fa fa-calendar text-primary"></i>
                                </span>
                                <h6 class="mb-0 fw-bold">Date & Statut</h6>
                            </div>
                            <p class="mb-1 ms-5 text-muted">
                                <i class="fa fa-clock mr-2 small"></i>Créée le: {{ order.createdAt|date('d/m/Y à H:i') }}
                            </p>
                            {% if order.updatedAt %}
                            <p class="mb-0 ms-5 text-muted">
                                <i class="fa fa-sync mr-2 small"></i>Mise à jour: {{ order.updatedAt|date('d/m/Y à H:i') }}
                            </p>
                            {% endif %}
                        </div>
                        
                        {% if order.size %}
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span class="icon-big text-center icon-primary mr-3">
                                    <i class="fa fa-ruler text-primary"></i>
                                </span>
                                <h6 class="mb-0 fw-bold">Taille</h6>
                            </div>
                            <p class="mb-0 ms-5 text-muted">
                                {{ order.size }}
                            </p>
                        </div>
                        {% endif %}
                        
                        {% if order.notes is not empty %}
                        <div class="mb-0">
                            <div class="d-flex align-items-center mb-2">
                                <span class="icon-big text-center icon-primary mr-3">
                                    <i class="fa fa-comment text-primary"></i>
                                </span>
                                <h6 class="mb-0 fw-bold">Notes additionnelles</h6>
                            </div>
                            <div class="ms-5 p-3 bg-light rounded-3 border">
                                <p class="mb-0">{{ order.notes|nl2br }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
                    
        <!-- Shipping & Billing Information Card -->        
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-3 h-100">
                <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i class="fa fa-map-marker mr-2 text-primary"></i>Informations de livraison</h5>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex flex-column">
                        <!-- Shipping Address -->                        
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="icon-big text-center icon-success mr-3">
                                    <i class="fa fa-truck text-success"></i>
                                </span>
                                <h6 class="mb-0 fw-bold">Adresse de livraison</h6>
                            </div>
                            <div class="ms-5 p-3 bg-light rounded-3 border">
                                <p class="mb-1"><i class="fa fa-home mr-2 text-muted"></i>{{ order.shippingAddress }}</p>
                                {% if order.city %}
                                <p class="mb-1"><i class="fa fa-building mr-2 text-muted"></i>{{ order.city }}</p>
                                {% endif %}
                                {% if order.postalCode %}
                                <p class="mb-0"><i class="fa fa-envelope mr-2 text-muted"></i>{{ order.postalCode }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Billing Address -->                        
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="icon-big text-center icon-warning mr-3">
                                    <i class="fa fa-file-text text-warning"></i>
                                </span>
                                <h6 class="mb-0 fw-bold">Adresse de facturation</h6>
                            </div>
                            <div class="ms-5 p-3 bg-light rounded-3 border">
                                <p class="mb-0"><i class="fa fa-home mr-2 text-muted"></i>{{ order.billingAddress ?: order.shippingAddress }}</p>
                            </div>
                        </div>
                        
                        <!-- Order Total -->                        
                        <div class="mt-auto">
                            <div class="d-flex align-items-center mb-2">
                                <span class="icon-big text-center icon-primary mr-3">
                                    <i class="fa fa-money text-primary"></i>
                                </span>
                                <h6 class="mb-0 fw-bold">Total de la commande</h6>
                            </div>
                            <div class="ms-5">
                                <h3 class="fw-bold text-primary mb-0">{{ order.totalAmount|number_format(2, ',', ' ') }} <span class="fs-6">TND</span></h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Items Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0 fw-bold"><i class="fa fa-shopping-basket mr-2 text-primary"></i>Articles commandés</h5>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 10%" class="text-center">Image</th>
                                    <th style="width: 40%">Produit</th>
                                    {% if order.items|first.size is defined %}
                                    <th class="text-center">Taille</th>
                                    {% endif %}
                                    {% if order.items|first.colorName is defined %}
                                    <th class="text-center">Couleur</th>
                                    {% endif %}
                                    <th class="text-center">Prix unitaire</th>
                                    <th class="text-center">Quantité</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items %}
                                <tr>
                                    <td class="text-center">
                                        {% if item.product.getPrimaryImage() is defined and item.product.getPrimaryImage() %}
                                            <img src="{{ asset('uploads/products/' ~ item.product.getPrimaryImage().imagePath) }}" alt="{{ item.product.name }}" class="rounded" width="50" height="50" style="object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                <i class="fa fa-image text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.product is defined and item.product %}
                                            <p class="mb-0 fw-bold">{{ item.product.name }}</p>
                                            <small class="text-muted">ID: {{ item.product.id }}</small>
                                            {% if item.product.stock is defined %}
                                                <br><small class="{% if item.product.stock > 10 %}text-success{% elseif item.product.stock > 0 %}text-warning{% else %}text-danger{% endif %}">
                                                    <i class="fa {% if item.product.stock > 10 %}fa-check-circle{% elseif item.product.stock > 0 %}fa-exclamation-circle{% else %}fa-times-circle{% endif %} mr-1"></i>
                                                    Stock: {{ item.product.stock }}
                                                </small>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-danger">Produit supprimé</span>
                                        {% endif %}
                                    </td>
                                    {% if item.size is defined %}
                                    <td class="text-center">
                                        {% if item.size %}
                                            <span class="badge bg-light text-dark">{{ item.size }}</span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    {% if item.colorName is defined %}
                                    <td class="text-center">
                                        {% if item.colorName %}
                                            <div class="d-flex align-items-center justify-content-center">
                                                <span class="color-sample mr-2" style="background-color: {{ item.colorCode }}; width: 15px; height: 15px; display: inline-block; border-radius: 50%; border: 1px solid #ddd;"></span>
                                                <span>{{ item.colorName }}</span>
                                            </div>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    <td class="text-center">{{ item.price|number_format(2, ',', ' ') }} TND</td>
                                    <td class="text-center">
                                        <span class="badge bg-primary rounded-pill px-3 py-2">{{ item.quantity }}</span>
                                    </td>
                                    <td class="text-end fw-bold">{{ (item.price * item.quantity)|number_format(2, ',', ' ') }} TND</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">
                                        <i class="fa fa-box-open fa-2x mb-2"></i>
                                        <p class="mb-0">Aucun article trouvé pour cette commande</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="{% if order.items|first.size is defined and order.items|first.colorName is defined %}6{% elseif order.items|first.size is defined or order.items|first.colorName is defined %}5{% else %}4{% endif %}" class="text-end fw-bold">Total:</td>
                                    <td class="text-end fw-bold fs-5 text-primary">{{ order.totalAmount|number_format(2, ',', ' ') }} TND</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(document).ready(function() {
            // Initialize DataTables if any exist
            if ($('#recent-orders').length) {
                $('#recent-orders').DataTable({
                    "pageLength": 5,
                    "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "Tous"]],
                    "language": {
                        "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
                    }
                });
            }
            
            // Function to confirm status change
            window.confirmStatusChange = function(status) {
                let statusText = '';
                switch(status) {
                    case 'pending': statusText = 'En attente'; break;
                    case 'done': statusText = 'Terminée'; break;
                    case 'canceled': statusText = 'Annulée'; break;
                }
                return confirm(`Êtes-vous sûr de vouloir changer le statut de la commande en "${statusText}" ?`);
            }
        });
        
        // Update product stock function
        function updateProductStock() {
            if (confirm('Êtes-vous sûr de vouloir mettre à jour le stock pour cette commande ?')) {
                // Disable button to prevent multiple clicks
                const button = document.querySelector('button[onclick="updateProductStock()"]');
                button.disabled = true;
                button.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> Mise à jour en cours...';
                
                // Get order items
                const orderItems = [];
                {% for item in order.items %}
                    {% if item.product is defined and item.product %}
                    orderItems.push({
                        productId: {{ item.product.id }},
                        quantity: {{ item.quantity }},
                        productName: "{{ item.product.name }}"
                    });
                    {% endif %}
                {% endfor %}
                
                // Process each item and update stock
                const updatePromises = [];
                const results = [];
                
                orderItems.forEach(item => {
                    updatePromises.push(
                        fetch('/api/products/' + item.productId)
                            .then(response => response.json())
                            .then(product => {
                                // Calculate new stock
                                const currentStock = product.stock;
                                const newStock = Math.max(0, currentStock - item.quantity);
                                
                                // Update stock
                                return fetch('/api/products/' + item.productId + '/update-stock', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ stock: newStock })
                                })
                                .then(() => {
                                    results.push({
                                        id: item.productId,
                                        name: item.productName,
                                        oldStock: currentStock,
                                        newStock: newStock,
                                        quantity: item.quantity
                                    });
                                });
                            })
                    );
                });
                
                // Handle all updates
                Promise.all(updatePromises)
                    .then(() => {
                        // Re-enable button
                        button.disabled = false;
                        button.innerHTML = '<i class="fa fa-sync mr-2"></i> Mettre à jour le stock';
                        
                        // Create alert messages
                        let alertsHtml = '';
                        results.forEach(result => {
                            alertsHtml += `
                            <div class="alert alert-success alert-dismissible fade show rounded-3 shadow-sm mb-3" role="alert">
                                <i class="fa fa-check-circle mr-2"></i>
                                Produit #${result.id} (${result.name}): Stock mis à jour de ${result.oldStock} à ${result.newStock} (-${result.quantity} unités)
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            </div>`;
                        });
                        
                        // Insert alerts after the page header
                        $(alertsHtml).insertAfter('.page-header');
                        
                        // Reload the page after 2 seconds to refresh stock display
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('Error updating stock:', error);
                        button.disabled = false;
                        button.innerHTML = '<i class="fa fa-sync mr-2"></i> Mettre à jour le stock';
                        
                        const errorAlert = `
                            <div class="alert alert-danger alert-dismissible fade show rounded-3 shadow-sm mb-3" role="alert">
                                <i class="fa fa-exclamation-triangle mr-2"></i>
                                Erreur lors de la mise à jour du stock. Veuillez réessayer.
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            </div>`;
                        
                        $(errorAlert).insertAfter('.page-header');
                    });
            }
        }
    </script>
{% endblock %}
